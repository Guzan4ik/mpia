# Описание модулей и функций

Всего реализовано 4 основных модуля:

1. Модуль композиции и декомпозиции объектов 
2. Модуль аугментации отдельных объектов
3. Модуль аугментации подобъектов в рамках объекта
4. Модуль замены и дополнения фона

Также, в библиотеке присутствуют вспомогательные файлы и демонстрационные. Функционал одного модуля может быть реализован в нескольких файлах с кодом, и один файл с кодом может содержать функционал одного и более модулей.

Ниже представлено более подробное описание.

## 1. Модуль композиции и декомпозиции объектов

- decompose_compose:

Модуль композиции и декомпозиции объектов состоит из двух независимых частей: декомпозиции и композиции. Декомпозиция это анализ исходных данных, и составление статистик на их основе. Композиция это составление новых сцен на основе декомпозированных данных.
Пользователь не взаимодействует с этим модулем напрямую, а использует обертку Pipeline.

- decompose_compose/dataset_statistics.py

Основная функция в этом файле - plant_statistics.

- metadata/create_metadata.py

Основная функция в этом файле – create_metadata_datasets. В качестве входного параметра функция принимает путь к папке с аннотированными данными – path_ann. Для файлов с базовой аннотацией записываются характеристики целевых объектов и подобъектов для дальнейшего расчета статистик. К основным характеристикам относятся размеры окаймляющей рамки, угол наклона, центр объекта, а также теги. Функция save_image_metadata сохраняет рассчитанные значения в новые файлы в той же директории с аннотацией (к именам файлов добавляется постфикс '_mpta.json')

- metadata/metadata.py

Файл содержит словари, позволяющие осуществлять переход от идентификационных номер классов объектов и типов подобъектов к их реальным названиям в датасетах. Также там представлены словари с характеристиками, которые возможно использовать для описания свойств объектов и подобъектов в наборе данных.

- metadata/polygon_masks.py

Функции в этом файле позволяют проводить обработку масок объектов в формате, получаемом на этапе разметки данных с помощью инструментов supervisely_lib. Для более удобного дальнейшего использования и обработки данных реализованы функции bitmap2rle, mask_2_base64, rleToMask и другие. В качестве входных данных функции принимают маску в одном формате, а возвращают маску в заданном формате. После приведения форматов возможна визуализация полученных масок в стандартном формате.

- decompose_compose/feature_sampling.py

В данном файле реализован класс FeatureSampler, который отвечает за сэмплирование признаков объектов на изображении.
Основной метод данного класса make_object_schema. Он составляет схему объекта. Метод не принимает аргументов. Схема объекта - это набор типов частей объекта и их расположение. Схема может быть составлена случайно на основе статистик датасета или быть копией существующего объекта в зависимости от настроек в конфигурационном файле. В схему включаются для каждого объекта: тип подобъекта, высота, ширина, координаты, угол поворота. Остальные методы являются вспомогательными.

- decompose_compose/object_sampler.py

В данном файле реализован класс ObjectSampler, который отвечает за подбор изображений объектов и соответствующих им масок, которые заполнят схему объекта, сформированную классом FeatureSampler. Основной метод данного класса - sample_object. Он принимает параметры:

* df - датафрейм со статистиками объектов датасета;

* max_retries - максимальное число попыток.

Остальные методы являются вспомогательными.

- decompose_compose/part_sampler.py

В данном файле реализован класс PartSampler, который отвечает за подбор частей объектов.Основной метод данного класса - sample. Он принимает параметр:
 
* class_type - название типа подобъекта.

Остальные методы являются вспомогательными.

- decompose_compose/scene_composer.py

В данном файле реализован класс SceneComposer, который отвечает за составление финального изображения. Основной метод данного класса - compose_img. Он располагает новые объекты на новом фоне. В зависимости от настроек в конфигурационном файле, объекты могут располагаться случайно или равномерно. При случайном расположении, объекты, которые наложились слишком сильно, будут итеративно вставлены еще раз. 
Метод compose_img принимает параметры:

* objects - список новых объектов;

* background - новое изображение с фоном.

Остальные методы являются вспомогательными. 


## 2. Модуль аугментации отдельных объектов

- augmentation/multipart_augmentations.py

В данном файле реализован класс DatasetAugmentor. Он необходим как для аугментации отдельных объектов так и для аугментации подобъектов в рамках объекта. В рамках  аугментации отдельных объектов основным является метод augment_objects. Он принимает список объектов, и итеративно вызывает метод augment_object. Метод augment_object принимает параметры:

* obj_dict - словарь, включающий такую информацию об объекте как его изображение, маску и список подобъектов;

* aug - аугментация, которую нужно применить. 

Определяет нужно ли применить аугментацию вспомогательный метод _is_aug_applicable на основе конфигурационного файла аугментаций. 

Остальные методы относятся к модулю аугментации подобъектов в рамках объекта. 

- augmentation/object_schema_augmentation.py

В данном файле реализована функция augment_object_schema, которая аугментирует схему выбранного объекта. На данном этапе изменяется именно целевое значение пространственных координат, а не изображение. Функция изменяет каждую составную часть объекта независимо. Функция принимает параметры:

* parts_data - словарь с целевыми координатами объекта;
* max_angle - максимальный угол, на который можно повернуть каждый из подобъектов исходного объекта.


## 3. Модуль аугментации подобъектов в рамках объекта

- augmentation/multipart_augmentations.py

В данном файле реализован класс DatasetAugmentor. Он необходим как для аугментации отдельных объектов так и для аугментации подобъектов в рамках объекта. В рамках  аугментации подобъектов в рамках объекта основным является метод augment_part. Он принимает словарь с информацией о подобъекте, включающей изображение и маску подобъекта. Определяет нужно ли применить аугментацию вспомогательный метод _is_aug_applicable на основе конфигурационного файла аугментаций.

Остальные методы относятся к модулю аугментации отдельных объектов. 

- augmentation/spatial_augmentations.py

В данном файле реализованы обертки над геометрическими преобразованиями, которые позволяют привести размеры объектов к заданным схемой объекта.. 

Декоратор fall_safe_transform позволяет пропускать преобразования, которые не получается применить, например, если изображение части объекта слишком маленькое.

Функция pad_image добавляет паддинг вокруг изображения объекта. Это необходимо для того, чтобы при вращениях не отрезались части изображения. После основных преобразований, выполняется обратная функция unpad_image.

Функция spatial_transform обеспечивает правильный порядок выполнения перечисленных выше функций и непосредственно трансформаций: изменения размера и вращение.

Функция mild_spatial_transform является основной в данном файле. Ее функционал дублирует функцию spatial_transform, но приводит объект к базовому виду перед преобразованиями. Базовым видом объекта мы считает такой его поворот, при котором угол между его основной диагональю и горизонтом равен нулю. Это сделано для унификации статистик о всех объектах в датасете. Поскольку объекты на исходных изображениях повернуты по-разному, статистики из абсолютных размеров дают мало информации о реальных пропорциях фотографируемых объектов. И, если при сэмплировании признаков нового объекта, мы возьмем за основу, например, размеры горизонтально расположенного объекта, а изображение вертикально расположенного объекта, то мы слишком неестественно изменим пропорции нового объекта. Для нивелирования описанного эффекта мы поворачиваем объекты до базового вида, производим необходимые преобразования, и доворачиваем не необходимый угол. Таким образом, преобразование будет щадящим и более натуральным.

## 4. Модуль замены и дополнения фона

- background_generation/background_generation.py

Данный файл реализует класс BackgroundSampler. Он необходим для выбора нового фонового изображения. В зависимости от настроек в конфигурационном файле могут возвращаться или изображения добавленные пользователем в указанную им папку или генерироваться новые. 

Метод sample_from_folder выбирает случайное фото из папки, указанной в конфигурационном файле, и приводит его к заданному размеру.

Метод generate_online генерирует новое изображение на основе других изображений в исходном датасете. Он принимает параметры:

* img - исходное изображение из датасета;

* save - булевая переменная, определяющая нужно ли сохранять в папку сгенерированное изображение.

Класс BackgroundSampler использует вспомогательные функции в том числе из файлов background_generation/generate_image.py, background_generation/superres.py и background_description/background_description.py.

## 5. Вспомогательный

- decompose_compose/pipeline.py

Класс Pipeline - это точка входа, обертка над основным функционалом библиотеки. Позволяет выбирать режимы работы. Примеры доступны в ноутбуке pipeline_modes.ipynb.

Принимает на вход: 

* project_config_path - путь к конфигурационному json файлу; опционально, вместо этого аргумента можно передать аргумент project_config,  содержащий конфигурационный словарь.

* feature_sampler_limitations - словарь с правилами ограничения сэмплируемых данных;

* verbose - булевая переменная, отвечающая за наличие вывода вспомогательной информации. 

Класс имеет такие основные методы как prepare и run.

Метод prepare вызывается без параметров, и подготавливает необходимые данные для дальнейшей работы. В частности, он считает статистические данные датасета, если они еще не посчитаны, и генерирует фоны, если они ещё не сгенерированы. 

Метод run генерирует изображение и маску. Он принимает параметры:

* num_objects - количество объектов на фото. Этот параметр задаёт мягкое условие, т.е., если не получится расположить заданное количество объектов, их может быть меньше;

* return_at_least_one - булевый параметр, который позволяет гарантировать, что на изображении будет хотя бы один объект;

* max_reties - максимальное количество попыток сгенерировать изображение таким образом, чтобы на нем был хотя бы один объект.

В классе также есть ряд вспомогательных функций, с которыми пользователь не взаимодействует.

- utils

Данная папка содержит вспомогательные файлы для загрузки и преобразования данных, базовых операций, абстрактный класс моделей, функционал для создания отчета по статистикам используемых датасетов.


## 6. Функционал для псевдосегментации объектов

- Segmentation_mask_creation_with_CLIPSeg_for_MPIA.ipynb

Представленный подход позволяет получить автоматизированную разметку, которая уступает в качестве ручной разметке, но ее можно получить дешево в больших количествах, поэтому она очень важна для обучения больших моделей.
Основная функция в данном ноутбуке – create_seg_mask. В качестве входных параметров функция принимает: 

* input_img – изображение в стандартном формате, считанное из растрового файла с помощью функции библиотеки PIL;

* prompts – список строк, каждая из которых представляет отдельный запрос. 

На основе текстовых запросов предобученный алгоритм выделяет области интереса на изображении, наилучшим образом соответствующие запросам. Функция возвращает список изображений, количество изображений совпадает с количество текстовых запросов. Каждое изображение содержит heatmap областей, соответствующих данному запросу. Также в ноутбуке приведен пример бинаризации изображения по порогу с помощью функции библиотеки Opencv. С помощью данной функции можно получить бинарную маску целевого объекта с ее дальнейшим сохранением в отдельный файл.


## 7. Функционал для встраивания объектов на новые сцены

- utils/paste.py

Данный функционал является частью модуля композиции и декомпозиции объектов, но вынесен в утилиты. 
Реализовано 2 способа встраивания объектов на новые фоны: простое копирование и Пуассоновское редактирование.

Простое копирование реализовано в функции paste_object_simple. Она просто вставляет новые пиксели на место старых по маске. Функция paste_object_simple принимает параметры:

* background - новый фон;

* source - сгенерированное изображение новых объектов;

* source_mask - сгенерированная маска новых объектов;

* x - х координата для вставки объекта;

* y - y координата для вставки объекта.

Пуассоновское редактирование реализовано в функции paste_object_poisson. Она смешивает пиксели двух изображений. Функция paste_object_poisson принимает параметры:

* background - новый фон;

* source - сгенерированное изображение новых объектов;

* source_mask - сгенерированная маска новых объектов;

* x - х координата для вставки объекта;

* y - y координата для вставки объекта;

* backend - внутренний параметр библиотеки fpie, отвечающий за то какая реализация будет использована.

Эта функция также используется для функционала переноса свойств объекта. В демонстрационном ноутбуке property_transfer.ipynb показан пример переноса болезни на здоровое яблоко. При этом дополнительно используется функция random_mask, которая генерирует случайную маску, внутри которой будет перенесено свойство. 
